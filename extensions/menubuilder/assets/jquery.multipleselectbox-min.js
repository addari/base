/*
 jQuery Multiple Select Box Plugin 0.7.3

 http://plugins.jquery.com/project/jquerymultipleselectbox
 http://code.google.com/p/jquerymultipleselectbox/

 Apache License 2.0 - http://www.apache.org/licenses/LICENSE-2.0

 @author Dreamltf
 @date 2013/03/20

 Depends: jquery.js (1.2+)
*/
(function(f){function v(a,b,d,e){if(!d.onSelectStart)return!0;a=d.onSelectStart.apply(b[0],[a,e]);return"boolean"!=typeof a||a}function x(a){return f.map(a,function(b){return f(b).getMultipleSelectBoxRowIndex()})}function y(a,b){var d=a.length;b-=1;return 0>b||b>=d?-1:!a.eq(b).isMultipleSelectBoxRowSelectable()?y(a,b):b}function z(a,b){var d=a.length;b+=1;return 0>b||b>=d?-1:!a.eq(b).isMultipleSelectBoxRowSelectable()?z(a,b):b}function A(a,b,d,e,g,f){var c=b.rowInfoArray.length,h=b.rowInfoArray[g];
if(0>e||0>g||e>=c||g>=c||null==h)return null;var c=b.lastCurrentIndex,m=null,n=null!=f?f.mouseY:null,q=a[0].scrollTop,p=b.height,j=h.topPos,k=h.bottomPos;d&&(n=null!=f?f.mouseX:null,q=a[0].scrollLeft,p=b.width,j=h.leftPos,k=h.rightPos);if(null==n)if(e<g||e==g&&0<=c&&c<g){if(k<q||k-p>q)m=k-p}else{if(e>g||e==g&&(0>c||c>g))if(j<q||j+p<q)m=j}else n<b.topPos?m=j:n>b.bottomPos&&(m=k-p);return m}function t(a){return f("."+r).yieldMultipleSelectBox().each(function(){var b=f(this),d=b.getMultipleSelectBoxInfo();
if(null!=d){if(b.isMultipleSelectBoxSelecting()){b.removeClass(s);var e=b.getMultipleSelectBoxOptions(),g=b.getMultipleSelectBoxSelectedRows();e.onSelectEnd&&e.onSelectEnd.apply(b[0],[a,g,d.lastStartIndex,d.lastCurrentIndex,d.prevStartIndex,d.prevCurrentIndex]);e.onSelectChange&&(null==d.prevSelectedArray||x(d.prevSelectedArray).join()!=x(g).join())&&e.onSelectChange.apply(b[0],[a,g,d.prevSelectedArray,d.lastStartIndex,d.lastCurrentIndex,d.prevStartIndex,d.prevCurrentIndex]);e.submitField&&e.submitField.val(b.serializeMultipleSelectBox());
d.prevSelectedArray=g}d.prevStartIndex=d.lastStartIndex;d.prevCurrentIndex=d.lastCurrentIndex}})}var r="MultipleSelectBox",s="selecting",w=!!("ontouchstart"in window)||!!("onmsgesturechange"in window),B=/msie/.test(navigator.userAgent.toLowerCase()),C={maxLimit:-1,scrollSpeed:20,isHorizontalMode:!1,isTouchDeviceMode:"auto",isMouseEventEnabled:!0,isKeyEventEnabled:!0,submitField:null,onCreate:null,onSelectStart:null,onSelectEnd:null,onSelectChange:null,scrollDistanceCalculator:function(a,b,d){var e=
d.previousCurrentIndex;if(null==e)return 0;var g=b.rowInfoArray.length,f=0,c=d.mouseY,h=d.previousMouseY,m=b.topPos,n=b.bottomPos;a.isHorizontalMode&&(c=d.mouseX,h=d.previousMouseX,m=b.leftPos,n=b.rightPos);if(c<m){if(0<e&&(0>h||c<h))f=-1,d.moveDistanceTotal+=(m-c)/5}else if(c>n&&e<g-1&&(0>h||c>h))f=1,d.moveDistanceTotal+=(c-n)/5;return 0!=f?f*a.scrollSpeed/20*d.moveDistanceTotal:0}};f.extend(f.fn,{multipleSelectBox:function(a){a=f.extend({},C,a);"auto"==a.isTouchDeviceMode&&(a.isTouchDeviceMode=
w);return this.each(function(){var b=f(this);b.destroyMultipleSelectBox();b.addClass(r).addClass(a.isHorizontalMode?"horizontal":"vertical");b.data("options",a);b.css({userSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",WebkitUserSelect:"none"}).attr({unselectable:"on",tabindex:0}).bind("selectstart",function(b){b.preventDefault();return!1});b.recalculateMultipleSelectBox();var d=a,e=b.getMultipleSelectBoxCachedRows(),g=b.getMultipleSelectBoxInfo();if(d.isMouseEventEnabled){var l=f(document);
b.bind("mousedown",function(a){a.preventDefault();var e=a.target,c=f(e),h=c;if(e!=this){c.parent()[0]!=this?(e.focus(),h=c.parents("."+r+">*").eq(0)):this.focus();var j=h.getMultipleSelectBoxRowIndex(),k=j;if(v(a,b,d,j)){b.recalculateMultipleSelectBox(!0,!0);var u=e=w;d.isKeyEventEnabled&&(a.shiftKey?(k=j,j=g.lastStartIndex):a.ctrlKey&&(e=u=!0));b.addClass(s).drawMultipleSelectBox(j,k,{isGetPositionByCache:!0,isSelectionOpposite:e,isSelectionRetained:u,scrollPos:null});b.yieldMultipleSelectBox().bind("mouseenter",
function(){l.unbind("mousemove."+r)}).bind("mouseleave",function(){if(!(0>=d.scrollSpeed)){var a={mouseX:-1,mouseY:-1,moveDistanceTotal:0,previousCurrentIndex:k,previousMouseX:-1,previousMouseY:-1};l.bind("mousemove."+r,function(e){a.mouseX=e.pageX;a.mouseY=e.pageY;var c=a.previousCurrentIndex,f=d.scrollDistanceCalculator(d,g,a);if(0==f||null==c)k=-1;else{e=g.rowInfoArray.length;var h=-1,n=d.isHorizontalMode,q=g.scrollHeight,m=g.rowInfoArray[c],p=m.topPos;n&&(q=g.scrollWidth,p=m.leftPos);p+=f;if(0>
f)if(0<p)for(c-=1;0<=c;c--){f=g.rowInfoArray[c];if(p>=(n?f.leftPos:f.topPos))break;h=c}else h=0;else if(p<q)for(c+=1;c<e;c++){f=g.rowInfoArray[c];if(p<(n?f.rightPos:f.bottomPos))break;h=c}else h=e-1;0<=h&&(a.moveDistanceTotal=0);k=h}0<=k&&(b.drawMultipleSelectBox(j,k,{isGetPositionByCache:!0,isSelectionRetained:u,scrollPos:A(b,g,d.isHorizontalMode,j,k,a)}),a.previousCurrentIndex=k);a.previousMouseX=a.mouseX;a.previousMouseY=a.mouseY})}}).bind("mouseover",function(a){a=f(a.target);this==a.parent()[0]&&
(k=a.getMultipleSelectBoxRowIndex(),b.drawMultipleSelectBox(j,k,{isGetPositionByCache:!0,isSelectionRetained:u,scrollPos:null}))});B&&l.bind("mouseleave."+r,function(){l.one("mousemove."+r,function(a){a.button||t(a)})})}}});e.filter(".optgroup").bind("dblclick",function(a){var c=f(this);if(v(a,b,d,c.getMultipleSelectBoxRowIndex())){var c=c.getMultipleSelectBoxOptGroupItems(),e=c.length;0<e&&(0<d.maxLimit&&e>d.maxLimit&&(e=d.maxLimit),b.drawMultipleSelectBox(c.eq(0).getMultipleSelectBoxRowIndex(),
c.eq(e-1).getMultipleSelectBoxRowIndex(),{scrollPos:null}),b.addClass(s),t(a))}})}d.isKeyEventEnabled&&b.bind("keydown",function(a){if(a.target==this){var c=a.keyCode;if(37<=c&&40>=c||32==c){var f=g.lastCurrentIndex,h=!1,j=a.shiftKey;37==c||38==c?f=y(e,f):39==c||40==c?f=z(e,f):32==c&&(h=!0);if(v(a,b,d,f))return b.recalculateMultipleSelectBox(!0,!0),b.addClass(s).drawMultipleSelectBox(f,f,{isSelectionOpposite:h,isSelectionRetained:j}),t(a),!1}}});if(w){var c=d.isHorizontalMode;b.bind("touchstart",
function(a){a=a.originalEvent.touches[0];var d=a.pageY,e=this.scrollTop;c&&(d=a.pageX,e=this.scrollLeft);b.yieldMultipleSelectBox().bind("touchmove",function(a){a.preventDefault();a=a.originalEvent.touches[0];c?b.scrollLeft(e+(a.pageX-d)):b.scrollTop(e+(a.pageY-d))})})}a.onCreate&&b.bind("onCreate",a.onCreate);a.onSelectStart&&b.bind("onSelectStart",a.onSelectStart);a.onSelectEnd&&b.bind("onSelectEnd",a.onSelectEnd);a.onSelectChange&&b.bind("onSelectChange",a.onSelectChange);if(a.submitField&&"string"===
typeof a.submitField){var h=f("input[name="+a.submitField+"]");a.submitField=0<h.length?h:f("<input type='hidden' name='"+a.submitField+"' />").insertAfter(b)}a.onCreate&&a.onCreate.apply(b[0])})},getMultipleSelectBoxCachedRows:function(a,b){return this.pushStack(f.map(this,function(d){d=f(d);var e=d.data("rows");if(a||!e)e=d.children(),d.data("rows",e);b&&(e=e.filter(b));return e.get()}))},getMultipleSelectBoxSelectedRows:function(){return f.grep(this.getMultipleSelectBoxCachedRows(),function(a){a=
f(a);return a.isMultipleSelectBoxRowSelectable()&&a.isMultipleSelectBoxRowSelected()})},getMultipleSelectBoxOptGroupItems:function(a){return this.pushStack(f.map(this,function(b){b=f(b);for(var d=[],e=b;0<(e=e.next()).length&&e.isMultipleSelectBoxRowOptGroupItem();)d.push(e[0]);a&&(d=b.pushStack(d).filter(a).get());return d}))},getMultipleSelectBoxRowIndex:function(){return this.data("index")},getMultipleSelectBoxOptions:function(){return this.data("options")},getMultipleSelectBoxInfo:function(){return this.data("info")},
drawMultipleSelectBox:function(a,b,d){d=f.extend({isGetPositionByCache:!1,isSelectionOpposite:!1,isSelectionRetained:!1,scrollPos:-1},d);return this.each(function(){var e=f(this),g=e.getMultipleSelectBoxCachedRows(),l=e.getMultipleSelectBoxOptions();d.isGetPositionByCache||e.recalculateMultipleSelectBox(!0,!0);var c=e.getMultipleSelectBoxInfo(),h=c.rowInfoArray.length;if(0>a||0>b||a>=h||b>=h||0==l.maxLimit||!g.eq(a).isMultipleSelectBoxRowSelectable())return this;var m=Math.min(a,b),n=Math.max(a,b),
q=[],p=[],j=0;g.each(function(a){var b=f(this);b.removeClass(s);if(b.isMultipleSelectBoxRowSelectable()){var c=b.isMultipleSelectBoxRowSelected();m<=a&&a<=n?c?d.isSelectionOpposite?q.push(b):j++:p.push(b):c&&(d.isSelectionRetained?j++:q.push(b))}});h=p.length;if(0<l.maxLimit&&h+j>l.maxLimit)return this;g.eq(b).addClass(s);for(var g=0,k=q.length;g<k;g++)q[g].removeClass("selected");for(g=0;g<h;g++)p[g].addClass("selected");h=d.scrollPos;null!=h&&(l=l.isHorizontalMode,0>h&&(h=A(e,c,l,a,b,null)),null!=
h&&0<=h&&(l?e.scrollLeft(h):e.scrollTop(h)));c.lastStartIndex=a;c.lastCurrentIndex=b;return this})},serializeMultipleSelectBoxArray:function(){return f.map(this.getMultipleSelectBoxSelectedRows(),function(a){var b=f(a);a=b.is("[value-render]")?a.getAttribute("value-render"):b.text();return f.trim(a)})},serializeMultipleSelectBox:function(a){return this.serializeMultipleSelectBoxArray().join(null==a?",":a)},yieldMultipleSelectBox:function(){f(document).unbind("mouseleave."+r).unbind("mousemove."+r);
return this.unbind("mouseenter").unbind("mouseleave").unbind("mouseover").unbind("touchmove")},destroyMultipleSelectBox:function(){return this.yieldMultipleSelectBox().each(function(){var a=f(this);a.unbind("selectstart").unbind("mousedown").unbind("keydown").unbind("touchstart").unbind("onCreate").unbind("onSelectStart").unbind("onSelectEnd").unbind("onSelectChange");a.getMultipleSelectBoxCachedRows().unbind("dblclick").removeData("index");a.removeData("info").removeData("rows").removeData("options")})},
recalculateMultipleSelectBox:function(a,b,d,e){return this.each(function(){var g=f(this),l=g.getMultipleSelectBoxCachedRows(e),c=g.getMultipleSelectBoxInfo();c||(a=b=d=!0,c={},g.data("info",c));if(b){var h=[],m=-1,n=-1;l.each(function(a){var b=f(this),c=b.offset(),d=c.top,c=c.left;0==a&&(m=d,n=c);d-=m;c-=n;b.data("index",a);h.push({topPos:d,bottomPos:d+b.outerHeight(),leftPos:c,rightPos:c+b.outerWidth()})});c.rowInfoArray=h}a&&(l=g.offset(),c.topPos=l.top,c.bottomPos=c.topPos+g.outerHeight(),c.height=
g.innerHeight(),c.scrollHeight=this.scrollHeight,c.leftPos=l.left,c.rightPos=c.leftPos+g.outerWidth(),c.width=g.innerWidth(),c.scrollWidth=this.scrollWidth);d&&(c.lastStartIndex=c.lastCurrentIndex=c.prevStartIndex=c.prevCurrentIndex=-1,c.prevSelectedArray=null)})},isMultipleSelectBoxSelecting:function(){return this.hasClass(s)},isMultipleSelectBoxRowDisabled:function(){return this.hasClass("disabled")},isMultipleSelectBoxRowSelected:function(){return this.hasClass("selected")},isMultipleSelectBoxRowSelecting:function(){return this.hasClass(s)},
isMultipleSelectBoxRowOptGroup:function(){return this.hasClass("optgroup")},isMultipleSelectBoxRowOptGroupItem:function(){return this.hasClass("optgroupitem")},isMultipleSelectBoxRowSelectable:function(){return!this.isMultipleSelectBoxRowDisabled()&&!this.isMultipleSelectBoxRowOptGroup()}});f(document).bind("mouseup."+r,function(a){t(a)})})(jQuery);
